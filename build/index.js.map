{"version":3,"sources":["../src/index.js"],"names":["settings","micro","name","pluginId","errorHandler","plugin","id","middleware","client","__actions","queue","case","args","done","then","connect","on","applyActions","catch","close","Proxy","get","target","property","Object","keys","forEach","key"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;kBAEe,YAAmB;AAAA,MAAlBA,QAAkB,uEAAP,EAAO;;AAChC,SAAO,UAACC,KAAD,EAAQC,IAAR,EAAcC,QAAd,EAA2B;AAChC,QAAMC,eAAe,4BAAaH,KAAb,CAArB;AACA,QAAMI,SAAS,EAAEH,UAAF,EAAQI,IAAIH,QAAZ,EAAsBI,6BAAtB,EAAkCC,QAAQ,IAA1C,EAAf;AACA,QAAMC,YAAY,EAAlB;;AAEAR,UACGS,KADH,CACS;AACLC,YAAM,MADD;AAELC,YAAM,EAFD;AAGLC,YAAM;AAAA,eAAM,uBAAQb,QAAR,EACTc,IADS,CACJ;AAAA,iBAAWT,OAAOG,MAAP,GAAgBO,QAAQC,EAAR,CAAW,OAAX,EAAoBZ,YAApB,CAA3B;AAAA,SADI,EAETU,IAFS,CAEJG,aAAahB,KAAb,EAAoBQ,SAApB,CAFI,EAGTS,KAHS,CAGHd,YAHG,CAAN;AAAA;AAHD,KADT,EASGM,KATH,CASS;AACLC,YAAM,OADD;AAELC,YAAM,EAFD;AAGLC,YAAM;AAAA,eAAMR,OAAOG,MAAP,CAAcW,KAAd,GAAsBD,KAAtB,CAA4Bd,YAA5B,CAAN;AAAA;AAHD,KATT;;AAeA,WAAO,IAAIgB,KAAJ,CAAUf,MAAV,EAAkB;AACvBgB,SADuB,eACnBC,MADmB,EACXC,QADW,EACD;AACpB,YAAIA,YAAYD,MAAhB,EAAwB;AACtB,iBAAOA,OAAQC,QAAR,CAAP;AACD;;AAED,YAAIA,YAAYd,SAAhB,EAA2B;AACzB,iBAAOA,UAAWc,QAAX,CAAP;AACD;;AAED,eAAOlB,OAAOG,MAAP,CAAee,QAAf,CAAP;AACD;AAXsB,KAAlB,CAAP;AAaD,GAjCD;AAkCD,C;;AAED,SAASN,YAAT,CAAsBhB,KAAtB,EAA6BQ,SAA7B,EAAwC;AACtC,SAAO;AAAA,WAAUe,OACdC,IADc,oBAEdC,OAFc,CAEN,eAAO;AACd,UAAI,sBAAW,kBAASC,GAAT,CAAX,CAAJ,EAAgC;AAC9BlB,kBAAWkB,GAAX,IAAmB,kBAASA,GAAT,EAAe1B,KAAf,EAAsBO,MAAtB,EAA8BC,SAA9B,CAAnB;AACD,OAFD,MAEO;AACLA,kBAAWkB,GAAX,IAAmB,kBAASA,GAAT,CAAnB;AACD;AACF,KARc,CAAV;AAAA,GAAP;AASD","file":"index.js","sourcesContent":["import middleware from \"amqplib\";\nimport isFunction from \"lodash.isfunction\";\nimport connect from \"./connect\";\nimport actions from \"./actions\";\nimport ErrorHandler from \"./utils/error-handler\";\n\nexport default (settings = {}) => {\n  return (micro, name, pluginId) => {\n    const errorHandler = ErrorHandler(micro);\n    const plugin = { name, id: pluginId, middleware, client: null };\n    const __actions = {};\n\n    micro\n      .queue({\n        case: 'wait',\n        args: [],\n        done: () => connect(settings)\n          .then(connect => plugin.client = connect.on('error', errorHandler))\n          .then(applyActions(micro, __actions))\n          .catch(errorHandler)\n      })\n      .queue({\n        case: 'close',\n        args: [],\n        done: () => plugin.client.close().catch(errorHandler)\n      });\n\n    return new Proxy(plugin, {\n      get(target, property) {\n        if (property in target) {\n          return target[ property ];\n        }\n\n        if (property in __actions) {\n          return __actions[ property ];\n        }\n\n        return plugin.client[ property ];\n      }\n    })\n  };\n}\n\nfunction applyActions(micro, __actions) {\n  return client => Object\n    .keys(actions)\n    .forEach(key => {\n      if (isFunction(actions[ key ])) {\n        __actions[ key ] = actions[ key ](micro, client, __actions)\n      } else {\n        __actions[ key ] = actions[ key ];\n      }\n    })\n}"]}